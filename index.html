<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mastrland: è‘¬çˆ±Â·å®¶æ— (V5.0 æ²‰æµ¸ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-pink: #ff00ff;
            --neon-green: #00ff00;
            --neon-blue: #00ffff;
            --neon-yellow: #ffff00;
            --neon-red: #ff3333;
            --neon-purple: #9d00ff;
            --bg-color: #050005;
            --font-main: 'VT323', "SimSun", monospace;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

        body {
            margin: 0; padding: 0;
            background-color: #000;
            color: #ddd;
            font-family: var(--font-main);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-image: 
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
        }

        #game-frame {
            width: 100%; max-width: 450px; height: 100%; max-height: 850px;
            background: var(--bg-color);
            border: 2px solid var(--neon-purple);
            box-shadow: 0 0 15px var(--neon-purple), inset 0 0 20px rgba(0,0,0,0.9);
            position: relative; display: flex; flex-direction: column; overflow: hidden;
        }

        .deco-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; opacity: 0.1; z-index: 0;
            background: url('data:image/svg+xml;utf8,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><text x="10" y="50" font-family="SimSun" font-size="20" fill="white">æ®ºé¦¬ç‰¹</text></svg>');
        }

        /* Buttons */
        .btn {
            background: #111; border: 1px solid #666; color: #fff; padding: 12px;
            font-family: var(--font-main); font-size: 1.1rem; cursor: pointer;
            box-shadow: 3px 3px 0 #333; transition: all 0.1s;
            text-shadow: 1px 1px 0 #000; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 #333; }
        .btn.disabled { opacity: 0.5; cursor: not-allowed; border-color: #444; color: #777; box-shadow: none; transform: none !important; }
        .btn-primary { border-color: var(--neon-pink); color: var(--neon-pink); box-shadow: 3px 3px 0 var(--neon-pink); }
        .btn-action { border-color: var(--neon-blue); color: var(--neon-blue); box-shadow: 3px 3px 0 var(--neon-blue); }
        .btn-danger { border-color: var(--neon-red); color: var(--neon-red); box-shadow: 3px 3px 0 var(--neon-red); }

        /* HUD */
        #hud {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; background: #1a0520; border-bottom: 2px dashed var(--neon-pink); z-index: 10;
        }
        .hud-avatar-frame {
            width: 48px; height: 48px; border: 2px solid var(--neon-green); 
            background: #000; display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .hud-info { margin-left: 10px; display: flex; flex-direction: column; }
        .hud-stats { display: flex; gap: 12px; font-size: 0.9rem; color: #ccc; }
        .stat-val { color: var(--neon-yellow); font-weight: bold; }
        
        .family-badge {
            position: absolute; bottom: -5px; right: -5px; background: var(--neon-purple); 
            color: #fff; font-size: 0.6rem; padding: 2px 4px; border-radius: 4px; display: none;
        }

        #turn-banner {
            background: var(--neon-purple); color: #fff; text-align: center; font-size: 0.9rem;
            padding: 3px; border-bottom: 1px solid #fff; font-family: "SimSun"; letter-spacing: 2px;
        }

        /* Map */
        #map-container {
            flex: 1; overflow-y: auto; padding: 20px;
            background: radial-gradient(circle, #220022 0%, #000 100%);
            scrollbar-width: none; position: relative; z-index: 1;
        }
        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px;
            padding-bottom: 80px;
        }
        .tile {
            aspect-ratio: 1; border: 1px solid #444; border-radius: 4px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; background: rgba(0,0,0,0.6); transition: 0.2s;
        }
        .tile.active { 
            border: 2px solid #fff; box-shadow: 0 0 15px var(--neon-pink); z-index: 2; 
            background: rgba(255,0,255,0.2); transform: scale(1.1);
        }
        .tile.locked { filter: grayscale(1) brightness(0.5); border: 1px dashed #333; pointer-events: none; }
        .tile-icon { font-size: 1.8rem; margin-bottom: 2px; filter: drop-shadow(0 0 5px var(--neon-blue)); }
        .tile-name { font-size: 0.7rem; color: #aaa; text-align: center; line-height: 1; font-family: "SimSun"; }
        
        .t-school { border-color: var(--neon-blue); color: var(--neon-blue); }
        .t-work { border-color: var(--neon-green); color: var(--neon-green); }
        .t-boss { border-color: var(--neon-red); animation: pulse 2s infinite; }
        .t-cafe { border-color: var(--neon-purple); color: var(--neon-purple); }

        /* Token */
        .token {
            width: 32px; height: 32px; position: absolute; z-index: 10;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.3s ease-out; filter: drop-shadow(0 0 5px #fff);
        }
        .hair-shape {
            width: 100%; height: 100%; position: absolute; top: -5px;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%); background: var(--token-color);
        }
        .face-shape {
            position: absolute; bottom: 0; width: 18px; height: 18px;
            background: #ffe0bd; border-radius: 50%; border: 1px solid #000;
        }

        /* Controls */
        #controls {
            padding: 10px; background: #111; border-top: 2px solid var(--neon-pink);
            display: flex; flex-direction: column; gap: 8px; z-index: 10;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }
        #log {
            height: 100px; /* Taller log area */
            overflow-y: auto; font-size: 0.95rem; color: var(--neon-green);
            background: #000; padding: 8px; border: 1px solid #333; 
            font-family: "SimSun", monospace; line-height: 1.4;
        }
        .martian { color: var(--neon-pink); font-family: "SimSun"; font-style: italic; }
        .sys-msg { color: #888; }

        /* Modals */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .modal-box {
            width: 90%; max-width: 380px; padding: 20px; background: #000;
            border: 2px solid var(--neon-blue); box-shadow: 0 0 30px rgba(0,255,255,0.2);
            text-align: center; position: relative; max-height: 90vh; overflow-y: auto;
        }
        .modal-box::after {
            content: "â˜… MASTRLAND â˜…"; position: absolute; bottom: 2px; right: 5px;
            font-size: 0.6rem; color: #333;
        }

        /* Lists */
        .opt-list { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
        .char-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .char-card { border: 1px solid #fff; padding: 8px; cursor: pointer; text-align: center; background: #222; }
        .char-card.selected { border-color: var(--neon-pink); box-shadow: 0 0 10px var(--neon-pink); background: #300; }
        
        .fam-btn { border: 1px solid #555; padding: 10px; margin-bottom: 5px; cursor: pointer; text-align: left;}
        .fam-btn:hover { border-color: var(--neon-purple); background: #110011; }

        @keyframes pulse { 0%{opacity:1} 50%{opacity:0.6} 100%{opacity:1} }
    </style>
</head>
<body>

<div id="game-frame">
    <div class="deco-bg"></div>
    <div id="turn-banner">ç³»çµ±åŠ è¼‰ä¸­...</div>
    
    <div id="hud">
        <div style="display:flex; align-items:center;">
            <div class="hud-avatar-frame">
                <div id="p-avatar-visual" style="width:100%;height:100%;position:relative;">
                    <div class="hair-shape" id="hud-hair" style="top:5px; transform:scale(0.8);"></div>
                </div>
                <div class="family-badge" id="hud-fam">æ— </div>
            </div>
            <div class="hud-info">
                <div id="p-name" style="color:#fff; font-family:'SimSun'; font-weight:bold;">Player</div>
                <div id="p-job" style="font-size:0.7rem; color:var(--neon-green);">æ— ä¸š</div>
            </div>
        </div>
        <div class="hud-stats">
            <div>ğŸ’° <span class="stat-val" id="p-money">0</span></div>
            <div>ğŸ’– <span class="stat-val" id="p-mood">0</span></div>
            <div>ğŸ‘‘ <span class="stat-val" id="p-social">0</span></div>
        </div>
    </div>

    <div id="map-container">
        <div class="grid" id="game-grid"></div>
    </div>

    <div id="controls">
        <div id="log">
            <span style="color:var(--neon-pink)">>>> è‘¬çˆ±Â·å®¶æ— <<<</span><br>
            åœ¨è¿™ä¸ªå†°å†·çš„ä¸–ç•Œï¼Œåªæœ‰å‘å‹æ˜¯æœ‰æ¸©åº¦çš„ã€‚
        </div>
        <div style="display: flex; gap: 8px;">
            <button id="btn-roll" class="btn btn-primary" style="flex:2" onclick="Game.rollDice()">ğŸ² æ“²éª°å­</button>
            <button id="btn-bag" class="btn btn-action" style="flex:1" onclick="Game.toggleBag()">ğŸ’</button>
            <button id="btn-help" class="btn" style="flex:0.5" onclick="Game.showRules()">â“</button>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="modal-overlay" class="modal-overlay">
    <div class="modal-box" id="modal-content">
        <!-- Content injected dynamically -->
    </div>
</div>

<script>
/** MASTRLAND CORE V5.0 - IMMERSIVE */

const ROLES = [
    { id: 'luoshang', name: 'ç½—æ®‡', title: 'æ€é©¬ç‰¹æ•™çˆ¶', color: '#ff00ff', quotes: ["ç¡ªå€‘æ˜¯ç³–ï¼Œç”œåˆ°æ†‚å‚·", "åˆ«åœ¨ç¡ªåŸå‰å“­"] },
    { id: 'xiaolu', name: 'å°è·¯', title: 'æºœå†°ç‹å­', color: '#00ffff', quotes: ["é£ä¸€æ ·çš„ç”·å­", "æ»‘è½®é‹æ˜¯ç¡ªçš„çµé­‚"] },
    { id: 'pipi', name: 'çš®çš®', title: 'çº¹èº«å¸ˆ', color: '#ff99ff', quotes: ["å§çš„å‚²éª¨ï¼Œä½ æ¨¡ä»¿ä¸æ¥", "å¿ƒè‹¥å‘é˜³"] },
    { id: 'dafei', name: 'å¤§é£', title: 'æƒ…åœ£', color: '#ffff00', quotes: ["åšä¸ªä¿—äººï¼Œè´ªè´¢å¥½è‰²", "çˆ±è¿‡ï¼Œç—›è¿‡"] }
];

const SKILLS = {
    'hair': { n: 'ç†å‘', cost: [100, 300, 800], max: 3 },
    'phone': { n: 'ä¿®æ‰‹æœº', cost: [150, 400, 1000], max: 3 },
    'motor': { n: 'ä¿®è½¦', cost: [200, 500, 1200], max: 3 },
    'tattoo': { n: 'çº¹èº«', cost: [300, 600, 1500], max: 3 }
};

const JOBS = {
    'hair': { n: 'å‘å»Š', wage: 120 },
    'phone': { n: 'æ‰‹æœºåº—', wage: 150 },
    'motor': { n: 'è½¦è¡Œ', wage: 180 },
    'tattoo': { n: 'çº¹èº«åº—', wage: 220 }
};

const FAMILIES = {
    'shamate': { n:'æ€é©¬ç‰¹', desc:'èµ„æœ¬è·å–+20%', color:'#ff00ff' },
    'zangai': { n:'è‘¬çˆ±', desc:'å¿ƒæƒ…æ¢å¤+5', color:'#bd00ff' },
    'smile': { n:'ç‹‚å°‘', desc:'æˆ˜æ–—åŠ›+10', color:'#ffff00' },
    'blood': { n:'è¡€é­”', desc:'æ‰“å·¥æ”¶å…¥+10%', color:'#ff0000' }
};

const ITEMS = {
    'bike': { n: 'é¬¼ç«æ‘©æ‰˜', cost: 500, desc: 'ç§»åŠ¨+1', type: 'passive' },
    'phone': { n: 'è¯ºåŸºäºš', cost: 300, desc: 'æ‰‹æœºåº—æ‰“å·¥åŠ æˆ', type: 'passive' },
    'tool': { n: 'å·¥å…·ç®±', cost: 150, desc: 'ä¿®è½¦æ‰“å·¥åŠ æˆ', type: 'passive' },
    'wig1': { n: 'ä¸ƒå½©çˆ†ç‚¸å¤´', cost: 300, desc: 'å¿ƒæƒ…ä¸Šé™+20', type: 'hair', class: 'wig-rainbow' },
    'wig2': { n: 'åˆºçŒ¬å¤´', cost: 200, desc: 'æˆ˜æ–—åŠ›+5', type: 'hair', class: 'wig-spike' },
    'cig': { n: 'æ•£èŠ±çƒŸ', cost: 20, desc: 'å¿ƒæƒ…+15 (æ¶ˆè€—å“)', type: 'consumable', effect: (p)=>{ p.mood+=15; return "å“¥æŠ½çš„ä¸æ˜¯çƒŸï¼Œæ˜¯å¯‚å¯ã€‚"; }}
};

// Map Data
const MAP = [
    { t:'start', i:'ğŸ ', n:'åŸä¸­æ‘', unlock:0 },
    { t:'factory', i:'ğŸ­', n:'ç”µå­å‚', unlock:0 },
    { t:'school', i:'ğŸ“', n:'è“ç¿”æŠ€æ ¡', unlock:0 },
    { t:'shop', i:'ğŸ›’', n:'åœ°æ‘Š', unlock:0 },
    { t:'work', i:'ğŸ’ˆ', n:'çš‡å®¶å‘å»Š', job:'hair', unlock:0 },
    { t:'enemy', i:'ğŸ‘®', n:'æ²»å®‰äº­', unlock:0 },
    { t:'work', i:'ğŸ”§', n:'å…„å¼Ÿè½¦è¡Œ', job:'motor', unlock:0 },
    { t:'cafe', i:'ğŸ’»', n:'é£å®‡ç½‘å§', unlock:0 }, // Net Cafe
    { t:'job', i:'ğŸ’¼', n:'äººæ‰å¸‚åœº', unlock:2 }, // Job Market
    { t:'work', i:'ğŸ“±', n:'æ‰‹æœºåº—', job:'phone', unlock:0 },
    { t:'tv', i:'ğŸ“º', n:'ç”µè§†å°', unlock:5 },
    { t:'work', i:'ğŸ²', n:'çº¹èº«åº—', job:'tattoo', unlock:3 },
    { t:'art', i:'ğŸ¨', n:'ç”»å»Š', unlock:8 },
    { t:'boss', i:'ğŸ‘¹', n:'é©¬è€æ¿', unlock:0 } // Boss Node
];

const Game = {
    players: [], turn: 0, round: 1, state: 'menu',

    init: function() {
        this.showCharSelect();
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && this.state === 'idle') {
                e.preventDefault(); this.rollDice();
            }
        });
    },

    // --- UI RENDERING ---
    
    showModal: function(html) {
        const el = document.getElementById('modal-content');
        el.innerHTML = html;
        document.getElementById('modal-overlay').style.display = 'flex';
    },
    
    closeModal: function() {
        document.getElementById('modal-overlay').style.display = 'none';
        if(this.state === 'event') this.nextTurn();
    },

    // --- CHAR SELECT ---
    
    showCharSelect: function() {
        let html = `<h2 style="color:var(--neon-pink);margin-top:0">â˜… é¸æ“‡èº«ä»½ â˜…</h2><div class="char-grid">`;
        ROLES.forEach((r, i) => {
            html += `<div class="char-card" id="char-${i}" onclick="Game.toggleSelect(${i})">
                <div style="font-size:2rem">${r.avatar || 'ğŸ¦¹'}</div>
                <div style="font-weight:bold;color:${r.color}">${r.name}</div>
                <div style="font-size:0.8rem;color:#aaa">${r.title}</div>
            </div>`;
        });
        html += `</div><div style="margin-top:15px"><button class="btn btn-primary" style="width:100%" onclick="Game.startGame()">é€²å…¥æ¸¸æˆ</button></div>`;
        this.showModal(html);
        this.selected = [];
    },

    toggleSelect: function(i) {
        if(this.selected.includes(i)) this.selected = this.selected.filter(x=>x!==i);
        else if(this.selected.length < 4) this.selected.push(i);
        
        // Update UI
        document.querySelectorAll('.char-card').forEach((el, idx) => {
            el.classList.toggle('selected', this.selected.includes(idx));
        });
    },

    startGame: function() {
        if(this.selected.length === 0) return alert("è¯·è‡³å°‘é€‰ä¸€ä¸ªäººï¼");
        this.players = this.selected.map(i => ({
            ...ROLES[i], money: 100, mood: 80, social: 20, pos: 0,
            jobExp: { hair:0, phone:0, motor:0, tattoo:0 },
            items: [], hairStyle: 'default', family: null, frozen: 0
        }));
        this.closeModal();
        this.state = 'idle';
        this.renderMap();
        this.createTokens();
        this.startTurn();
    },

    // --- GAME LOOP ---

    renderMap: function() {
        const grid = document.getElementById('game-grid');
        grid.innerHTML = '';
        MAP.forEach((t, i) => {
            const el = document.createElement('div');
            el.className = `tile t-${t.t}`;
            el.id = `tile-${i}`;
            if(this.round < t.unlock) {
                el.className += ' locked';
                el.innerHTML = `<div class="tile-icon">ğŸ”’</div><div class="tile-name">???</div>`;
            } else {
                el.innerHTML = `<div class="tile-icon">${t.i}</div><div class="tile-name">${t.n}</div>`;
            }
            grid.appendChild(el);
        });
    },

    createTokens: function() {
        const con = document.getElementById('map-container');
        this.players.forEach((p, i) => {
            const t = document.createElement('div');
            t.className = 'token';
            t.id = `tok-${i}`;
            t.style.setProperty('--token-color', p.color);
            t.innerHTML = `<div class="hair-shape"></div><div class="face-shape"></div>`;
            con.appendChild(t);
        });
        this.updateTokens();
    },

    updateTokens: function() {
        this.players.forEach((p, i) => {
            const tile = document.getElementById(`tile-${p.pos}`);
            const tok = document.getElementById(`tok-${i}`);
            
            // Hair visual update
            const hair = tok.querySelector('.hair-shape');
            hair.style.background = p.color; // Default
            if(p.hairStyle === 'wig1') { // Rainbow
                hair.style.clipPath = 'circle(50% at 50% 50%)';
                hair.style.background = 'radial-gradient(circle, red, orange, yellow, green, blue, purple)';
                hair.style.top = '-8px'; hair.style.width='120%';
            } else if(p.hairStyle === 'wig2') { // Spike
                hair.style.clipPath = 'polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%)';
                hair.style.top = '-10px';
            }

            const offset = (i - (this.players.length-1)/2) * 6;
            tok.style.left = (tile.offsetLeft + 15 + offset) + 'px';
            tok.style.top = (tile.offsetTop + 10 + offset) + 'px';
            
            if(i === this.turn) {
                tok.style.zIndex = 20; tok.style.transform = "scale(1.3)";
                tile.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                tok.style.zIndex = 10; tok.style.transform = "scale(1)";
            }
        });
    },

    curr: function() { return this.players[this.turn]; },

    startTurn: function() {
        this.state = 'idle';
        const p = this.curr();
        
        // HUD Update
        document.getElementById('p-name').innerText = p.name;
        document.getElementById('p-money').innerText = p.money;
        document.getElementById('p-mood').innerText = p.mood;
        document.getElementById('p-social').innerText = p.social;
        
        // Family Badge
        const famBadge = document.getElementById('hud-fam');
        if(p.family) {
            famBadge.style.display = 'block';
            famBadge.innerText = FAMILIES[p.family].n;
            famBadge.style.background = FAMILIES[p.family].color;
        } else famBadge.style.display = 'none';

        // HUD Hair update
        const hudHair = document.getElementById('hud-hair');
        hudHair.style.background = p.color;
        if(p.hairStyle === 'wig1') {
            hudHair.style.clipPath = 'circle(50% at 50% 50%)';
            hudHair.style.background = 'radial-gradient(circle, red, orange, yellow, green, blue, purple)';
        } else {
            hudHair.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
        }

        let jobTxt = "æ— ä¸š";
        for(let k in p.jobExp) if(p.jobExp[k]>0) jobTxt = `${SKILLS[k].n} Lv.${p.jobExp[k]}`;
        document.getElementById('p-job').innerText = jobTxt;

        document.getElementById('turn-banner').innerText = `>>> ç¬¬${this.round}å‘¨: ${p.name} çš„å›åˆ <<<`;
        
        // Passive Family Bonus
        if(p.family === 'zangai') { p.mood += 5; this.log("å®¶æ—buff: å¿ƒæƒ…+5"); }

        // Random Quote
        if(Math.random()<0.3) this.log(`<span class="martian" style="color:${p.color}">${p.name}: ${p.quotes[Math.floor(Math.random()*p.quotes.length)]}</span>`);
        
        if(p.money <= 0 || p.mood <= 0) {
            // Chance to recover instead of instant game over
            this.modal('âš ï¸ ç©·é€”æœ«è·¯', 'ğŸ’€', 'ä½ å¿«æ’‘ä¸ä¸‹å»äº†...', [
                { t:'å‘å®¶é‡Œè¦é’± (+50å…ƒ)', cb:()=>{ p.money+=50; p.social-=10; this.log("å¦ˆç»™ä½ æ‰“äº†50å—..."); this.closeModal(); } },
                { t:'ä¹è®¨ (+å¿ƒæƒ…)', cb:()=>{ p.mood+=30; p.social-=20; this.log("å°Šä¸¥ç®—ä»€ä¹ˆ..."); this.closeModal(); } },
                { t:'æ”¾å¼ƒ (ç»“æŸ)', cb:()=>{ this.gameOver(false); } }
            ]);
            return;
        }
    },

    nextTurn: function() {
        this.turn++;
        if(this.turn >= this.players.length) {
            this.turn = 0; this.round++;
            this.log(`=== ç¬¬ ${this.round} å‘¨ ===`);
            this.renderMap();
        }
        this.startTurn();
    },

    rollDice: function() {
        if(this.state !== 'idle') return;
        this.state = 'rolling';
        
        const p = this.curr();
        let bonus = p.items.includes('bike') ? 1 : 0;
        let roll = Math.floor(Math.random() * 6) + 1 + bonus;
        this.log(`${p.name} æ·å‡ºäº† ${roll} ç‚¹!`);
        
        let steps = roll;
        const timer = setInterval(() => {
            p.pos = (p.pos + 1) % MAP.length;
            this.updateTokens();
            steps--;
            if(steps <= 0) {
                clearInterval(timer);
                setTimeout(() => this.handleTile(), 500);
            }
        }, 150);
    },

    handleTile: function() {
        const p = this.curr(); const t = MAP[p.pos];
        if(this.round < t.unlock) {
            this.log(`[${t.n}] æ­£åœ¨æ–½å·¥ä¸­...(éœ€ç¬¬${t.unlock}å‘¨)`);
            this.nextTurn(); return;
        }
        
        this.state = 'event';
        switch(t.t) {
            case 'factory': this.evtFactory(); break;
            case 'school': this.evtSchool(); break;
            case 'work': this.evtWork(t.job); break;
            case 'shop': this.evtShop(); break;
            case 'boss': this.evtBoss(); break;
            case 'cafe': this.evtCafe(); break; // New Cafe Logic
            case 'job': this.evtJobMarket(); break;
            default: this.log(`åˆ°è¾¾ ${t.n}`); this.nextTurn();
        }
    },

    // --- EVENTS ---

    // 1. Boss Node: Salary or Penalty
    evtBoss: function() {
        const p = this.curr();
        let r = Math.random();
        let html = `<h2 style="color:var(--neon-red)">ğŸ‘¹ é©¬è€æ¿åŠå…¬å®¤</h2>`;
        let desc = "";
        let action = null;

        if (r < 0.6) {
            desc = "é©¬è€æ¿å¿ƒæƒ…ä¸é”™ï¼Œå‘äº†ä½ä¿ã€‚";
            action = () => { p.money += 100; this.log("é¢†åˆ°100å…ƒå·¥èµ„ã€‚"); this.closeModal(); };
        } else if (r < 0.9) {
            desc = "â€œä½ çš„å‘å‹å¤ªä¹±äº†ï¼æ‰£é’±ï¼â€";
            action = () => { p.money -= 50; p.mood -= 10; this.log("è¢«æ‰£50å…ƒã€‚"); this.closeModal(); };
        } else {
            desc = "â€œè¡¨ç°ä¸é”™ï¼Œå‡èŒåŠ è–ªï¼â€";
            action = () => { p.money += 200; p.social += 20; this.log("è·å¾—200å…ƒå¥–é‡‘ï¼"); this.closeModal(); };
        }

        this.showModal(`
            ${html}<p>${desc}</p>
            <div class="opt-list"><button class="btn btn-action" onclick="Game.currentBossAction()">ç¡®å®š</button></div>
        `);
        this.currentBossAction = action;
    },

    // 2. Net Cafe: Family & Chill
    evtCafe: function() {
        const p = this.curr();
        
        let btns = `<div class="opt-list">`;
        
        // Family Logic
        if(!p.family) {
            btns += `<button class="btn btn-primary" onclick="Game.showFamilies()">åŠ å…¥å®¶æ—</button>`;
        } else {
            btns += `<div style="color:${FAMILIES[p.family].color};font-size:0.9rem">å®¶æ—: ${FAMILIES[p.family].n}</div>`;
        }

        btns += `<button class="btn btn-action" onclick="Game.doSurf()">ä¸Šç½‘å†²æµª (-20å…ƒ +30å¿ƒæƒ…)</button>`;
        btns += `<button class="btn" onclick="Game.closeModal()">ç¦»å¼€</button></div>`;

        this.showModal(`<h2 style="color:var(--neon-blue)">ğŸ’» é£å®‡ç½‘å§</h2><p>è¿™é‡Œæ˜¯æˆ‘ä»¬çš„ç²¾ç¥å®¶å›­ã€‚</p>${btns}`);
    },

    doSurf: function() {
        const p = this.curr();
        p.money -= 20; p.mood += 30;
        this.log("åœ¨åŠ²èˆå›¢é‡Œé‡åˆ°äº†çœŸçˆ±...å¿ƒæƒ…å¤§å¥½ã€‚");
        this.closeModal();
    },

    showFamilies: function() {
        let html = `<h2 style="color:var(--neon-purple)">é€‰æ‹©å®¶æ—</h2><div class="opt-list">`;
        for(let k in FAMILIES) {
            let f = FAMILIES[k];
            html += `<div class="fam-btn" onclick="Game.joinFamily('${k}')">
                <b style="color:${f.color}">${f.n}</b><br><span style="font-size:0.7rem;color:#aaa">${f.desc}</span>
            </div>`;
        }
        this.showModal(html + `</div>`);
    },

    joinFamily: function(k) {
        const p = this.curr();
        p.family = k;
        this.log(`åŠ å…¥äº† [${FAMILIES[k].n}] å®¶æ—ï¼`);
        this.closeModal();
    },

    // 3. School (Logic)
    evtSchool: function() {
        const p = this.curr();
        let html = `<h2 style="color:var(--neon-blue)">ğŸ“ è“ç¿”æŠ€æ ¡</h2>`;
        
        let btns = `<div class="opt-list">`;
        for(let k in SKILLS) {
            let lvl = p.jobExp[k];
            if(lvl < SKILLS[k].max) {
                let cost = SKILLS[k].cost[lvl];
                let canAfford = p.money >= cost;
                
                btns += `<button class="btn ${canAfford ? 'btn-action' : 'disabled'}" 
                    onclick="${canAfford ? `Game.doLearn('${k}', ${cost})` : ''}">
                    è¿›ä¿®${SKILLS[k].n} (Lv.${lvl}â†’${lvl+1}) <br> <span style="font-size:0.8rem">å­¦è´¹: ${cost}</span>
                </button>`;
            }
        }
        btns += `<button class="btn" onclick="Game.closeModal()">ç¦»å¼€</button></div>`;
        this.showModal(html + btns);
    },

    doLearn: function(key, cost) {
        const p = this.curr();
        p.money -= cost;
        p.jobExp[key]++;
        this.log(`æŠ€èƒ½å‡çº§ï¼è·å¾—äº† ${SKILLS[key].n} Lv.${p.jobExp[key]}`);
        this.closeModal();
    },

    // 4. Work (Job & Shop Logic)
    evtWork: function(key) {
        const p = this.curr();
        const job = JOBS[key];
        const lvl = p.jobExp[key];
        
        let html = `<h2 style="color:var(--neon-green)">${MAP[p.pos].i} ${MAP[p.pos].n}</h2>`;
        let btns = `<div class="opt-list">`;

        // Work Button (Check Skill)
        if(lvl > 0) {
            let wage = job.wage * lvl;
            if(p.family === 'blood') wage = Math.floor(wage * 1.1); // Blood family bonus
            
            // Item bonus check
            if(key === 'phone' && p.items.includes('phone')) wage += 50;
            if(key === 'motor' && p.items.includes('tool')) wage += 50;

            btns += `<button class="btn btn-action" onclick="Game.doJob('${key}', ${wage})">
                æ‰“å·¥èµšé’± (+${wage})
            </button>`;
        } else {
            btns += `<button class="btn disabled">æ‰“å·¥ (éœ€${SKILLS[key].n}æŠ€èƒ½)</button>`;
        }

        // Shop in specific places
        if(key === 'hair') {
            btns += this.renderBuyBtn('wig1', p);
            btns += this.renderBuyBtn('wig2', p);
        } else if (key === 'phone') {
            btns += this.renderBuyBtn('phone', p);
        } else if (key === 'motor') {
            btns += this.renderBuyBtn('bike', p);
            btns += this.renderBuyBtn('tool', p);
        }

        btns += `<button class="btn" onclick="Game.closeModal()">ç¦»å¼€</button></div>`;
        this.showModal(html + btns);
    },

    renderBuyBtn: function(key, p) {
        const it = ITEMS[key];
        if(p.items.includes(key)) return ``; // Already bought
        let canAfford = p.money >= it.cost;
        return `<button class="btn ${canAfford ? 'btn-gold' : 'disabled'}" 
            onclick="${canAfford ? `Game.buyItem('${key}')` : ''}">
            è´­ä¹° ${it.n} (-${it.cost})
        </button>`;
    },

    doJob: function(key, wage) {
        const p = this.curr();
        p.money += wage; p.mood -= 10;
        this.log(`æ‰“å·¥ç»“æŸï¼Œèµšäº† ${wage}å…ƒã€‚`);
        this.closeModal();
    },

    buyItem: function(key) {
        const p = this.curr();
        const it = ITEMS[key];
        p.money -= it.cost;
        p.items.push(key);
        
        if(it.type === 'hair') {
            p.hairStyle = key;
            p.mood += 20; 
            this.log(`è´­ä¹°å¹¶æ¢ä¸Šäº† ${it.n}ï¼`);
            this.updateTokens();
        } else {
            this.log(`è´­ä¹°äº† ${it.n}`);
        }
        this.closeModal();
    },

    evtFactory: function() {
        this.showModal(`
            <h2>ğŸ­ ç”µå­å‚</h2>
            <p>æµæ°´çº¿ä¸å…»é—²äººã€‚</p>
            <div class="opt-list">
                <button class="btn btn-action" onclick="Game.doJobFactory()">æ¬ç – (+30å…ƒ)</button>
                <button class="btn" onclick="Game.closeModal()">ææ¡¶è·‘è·¯</button>
            </div>
        `);
    },
    doJobFactory: function() {
        const p = this.curr();
        p.money += 30; p.mood -= 5;
        this.closeModal();
    },

    evtShop: function() {
        const p = this.curr();
        let html = `<h2>ğŸ›’ åœ°æ‘Š</h2><div class="opt-list">`;
        html += this.renderBuyBtn('cig', p);
        html += `<button class="btn" onclick="Game.closeModal()">ç¦»å¼€</button></div>`;
        this.showModal(html);
    },
    
    evtJobMarket: function() {
        this.showModal(`
            <h2>ğŸ’¼ äººæ‰å¸‚åœº</h2>
            <p>è¿™é‡Œæ²¡æœ‰æˆ‘ä»¬è¦æ‰¾çš„å·¥ä½œã€‚</p>
            <div class="opt-list"><button class="btn" onclick="Game.closeModal()">ç¦»å¼€</button></div>
        `);
    },

    // Utils
    log: function(msg) { 
        const l = document.getElementById('log'); 
        l.innerHTML = `> ${msg}<br>` + l.innerHTML; 
    },
    
    toggleBag: function() {
        const p = this.curr();
        let html = `<h3 style="color:var(--neon-blue);margin-top:0">èƒŒåŒ…</h3><div style="text-align:left;font-size:0.9rem;display:grid;gap:5px;">`;
        if(p.items.length === 0) html += `ç©ºç©ºå¦‚ä¹Ÿ...`;
        
        p.items.forEach(k => {
            const it = ITEMS[k];
            html += `<div style="border:1px solid #555;padding:5px;">
                <b>${it.icon} ${it.n}</b><br><span style="color:#888;font-size:0.8rem">${it.desc}</span>
                ${it.type==='consumable' ? `<button class="btn btn-action" style="padding:2px;font-size:0.8rem;float:right" onclick="Game.useItem('${k}')">ä½¿ç”¨</button>` : ''}
            </div>`;
        });
        
        html += `</div><button class="btn" style="width:100%;margin-top:10px" onclick="Game.closeModal()">å…³é—­</button>`;
        this.showModal(html);
    },

    useItem: function(key) {
        const p = this.curr();
        const it = ITEMS[key];
        let msg = it.effect(p);
        alert(msg);
        this.updateHUD();
        this.closeModal(); 
    },

    showRules: function() {
        alert("ç›®æ ‡: èµšå¤Ÿ1000å…ƒå’Œ500èµ„æœ¬ã€‚\nè§„åˆ™: å»æŠ€æ ¡å­¦æŠ€èƒ½ -> å»å¯¹åº”åº—é“ºæ‰“å·¥ -> èµšé’±ä¹°è£…å¤‡ -> èµ°å‘äººç”Ÿå·…å³°ã€‚");
    },

    gameOver: function(win) {
        let html = win 
            ? `<h1 style="color:yellow">VICTORY</h1><p>ä½ å»ºç«‹äº†æ€é©¬ç‰¹å¸å›½ï¼</p>`
            : `<h1 style="color:grey">GAME OVER</h1><p>æ¢¦é†’äº†ï¼Œå›æ‘ç§ç”°å§ã€‚</p>`;
        html += `<button class="btn btn-primary" onclick="location.reload()">é‡æ¥</button>`;
        this.showModal(html);
    }
};

Game.init();
</script>
</body>
</html>